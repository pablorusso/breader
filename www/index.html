<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>::Breader:: El lector de noticias inteligente</title>
		<link href="styles/style_menu.css"   rel="stylesheet" type="text/css" />
		<link href="styles/style_common.css" rel="stylesheet" type="text/css" />
		<link href="styles/style_body.css" rel="stylesheet" type="text/css"   />

		<script type="text/javascript" src="scripts/xml.js"></script>
		<script type="text/javascript" src="scripts/show_data.js"></script>
		<script type="text/javascript" src="scripts/ajax_queue.js"></script>
		<script type="text/javascript" src="scripts/ajax_threads.js"></script>

		<script type="text/javascript">
			var tagsDocument  ;
			var feedsDocument ;
			var bodyDocument  ;

			// START ARTICLE
			var amIInDiv = false;
			function bodyHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;
				bodyDocument = result;
				showBody( document, bodyDocument );
			}
			function editArticleHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				var idToFind = getNodeAttr( result.documentElement.childNodes[1], 'id' );
				if ( idToFind == null )
				{
					showDiv( document, 'error_tag', "Editar Articulo - El nodo no tiene id" );
					return;
				}
				var nodeFound = findNodeById( bodyDocument.documentElement.childNodes[1], idToFind );
				bodyDocument.documentElement.childNodes[1].replaceChild( result.documentElement.childNodes[1], nodeFound );
				showBody( document, bodyDocument );
			}
			function keepCatsVisible()
			{
				if ( !amIInDiv ) amIInDiv = true;
			}
			function startTimerToSelectCat()
			{
				if ( amIInDiv ) amIInDiv = false;
				setTimeout( 'hideCatsMenu()', '800' );
			}
			function hideCatsMenu()
			{
				if ( amIInDiv ) return;
				var divWithCats = document.getElementById( 'tagsToLink' )
				hideDiv( document, 'tagsToLink', null );
			}
			function showCatsMenu( artId )
			{
				var allTagsDoc = tagsDocument.documentElement.childNodes[1]
				var artDoc = findNodeById( bodyDocument.documentElement.childNodes[1], artId );
				var tagsDoc = allTagsDoc.childNodes;

				var tagsUnlinkedText = "<tags>";
				for(i = 0;i < tagsDoc.length;i++)
				{
					var node = tagsDoc.item(i);
					var idTag = getNodeAttr( node, 'id' );
					var linkedTagNode = findNodeById( artDoc.childNodes[1], idTag );
					if ( linkedTagNode == null )
						tagsUnlinkedText += serializeXML( node );
				}
				tagsUnlinkedText += "</tags>";
				var tagsUnlinkedDoc = parseXML( tagsUnlinkedText );

				var divWithCats = document.getElementById( 'tagsToLink' )
				applyXSLT( 'add_tags.xslt', divWithCats, tagsUnlinkedDoc, 'artId', artId );
				assignPosition( divWithCats );
				showDiv( document, 'tagsToLink', null );
			}
			function linkTag( artId, tagId )
			{
				doAction ( "actionCode=" + escape( "A1" ) + "&params=" + escape( "tagId||#" + tagId + "|||artId||#" + artId ), editArticleHandler );
				if ( amIInDiv ) amIInDiv = false;
				hideCatsMenu();
			}
			// END ARTICLE

			// START FEEDS
			var countToRefresh = 0;
			function feedsHandler( result )
			{
				result = checkError( document, result );

				if ( result == null ) return;
				feedsDocument = result;
				showFeeds( document, feedsDocument );
			}
			function delFeedHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				var idToFind = getNodeAttr( result.documentElement.childNodes[1], 'id' );
				if ( idToFind == null )
				{
					showDiv( document, 'error_tag', "Borrar Feed - El nodo no tiene id" );
					return;
				}
				var nodeFound = findNodeById( feedsDocument.documentElement.childNodes[1], idToFind );
				feedsDocument.documentElement.childNodes[1].removeChild( nodeFound )
				showFeeds( document, feedsDocument );
			}
			function addFeedHandlerForReal( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;
				feedsDocument.documentElement.childNodes[1].appendChild( result.documentElement.childNodes[1] );
				showFeeds( document, feedsDocument );
			}
			function refreshFeedHandlerForReal( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				countToRefresh--;
				if ( countToRefresh == 0 )
				{
					doAction ( getCurrentBody(), bodyHandler, 'A' );
					doAction ( "actionCode=F3", feedsHandler, 'F' );
				}
			}
			function addFeedHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				var feedUrl  = getNodeAttr ( result.documentElement.childNodes[1], 'url' );
				var feedName = getNodeAttr ( result.documentElement.childNodes[1], 'name' );
				if ( feedUrl == null || feedName == null )
				{
					showDiv( document, 'error_tag', 'No se pudo recuperar la informacion del feed' );
					return;
				}
				doAction ( "actionCode=" + escape( "F1" ) + "&params=" + escape( "feedUrl||#" + feedUrl + "|||feedName||#" + feedName ), addFeedHandlerForReal, '' );
			}
			function refreshFeedHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				countToRefresh = 0;
				var children = result.documentElement.childNodes[1].childNodes;
				for( i = 0; i < children.length; i++ )
				{
					// Cada hijo es un articulo a agregar
					var node = children.item(i);

					var feedName = getNodeAttr( node, 'feedName' );
					var title    = getNodeAttr( node, 'title'    );
					var link     = getNodeAttr( node, 'link'     );
					var author   = getNodeAttr( node, 'author'   );
					var date     = getNodeAttr( node, 'date'     );

					var summary  = null;
					if ( node.firstChild != null )
						summary = node.firstChild.textContent;

					if ( 	feedName == null ||
							title == null ||
							summary == null ||
							link == null ||
							author == null ||
							date == null )
					{
						showDiv( document, 'error_tag', 'No se pudo recuperar la informacion del articulo a actualizar' );
						return;
					}

					var params = "";
					params += "feedName||#" + feedName;
					params += "|||title||#" + title;
					params += "|||summary||#" + summary;
					params += "|||link||#" + link;
					params += "|||author||#" + author;
					params += "|||date||#" + date;
					params = escape( params );

					countToRefresh++;
					doAction ( "actionCode=" + escape( "A0" ) + "&params=" + params, refreshFeedHandlerForReal, '' );
				}

				if ( countToRefresh == 0 )
				{
					doAction ( getCurrentBody(), bodyHandler, 'A' );
					doAction ( "actionCode=F3", feedsHandler, 'F' );
				}
			}
			function refreshFeed( feedId )
			{
				var node = findNodeById( feedsDocument.documentElement.childNodes[1], feedId );
				if ( node == null )
				{
					showDiv( document, 'error_tag', 'No se encontro el feed para actualizar' );
					return;
				}

				var feedUrl    = getNodeAttr( node, 'url' );
				var lastUpdate = getNodeAttr( node, 'lastUpdate' );
				if ( feedUrl == null || lastUpdate == null )
				{
					showDiv( document, 'error_tag', 'No se encontro el feed para actualizar' );
					return;
				}

				setCurrentBody( "actionCode=" + escape( "A5" ) + '&params=' + escape( "feedId||#" + feedId ) );
				doActionWithName ( "refresh_feed.php", "feedUrl=" + escape( feedUrl ) + "&lastUpdate=" + escape( lastUpdate ), refreshFeedHandler, '' );
			}
			function addFeed( inputId )
			{
				var txtInput = document.getElementById( inputId );
				var url = txtInput.value;
				if ( url == '' )
				{
					alert( 'Debe ingresar la direccion del feed' );
					return;
				}
				txtInput.value = "";
				doActionWithName ( "add_feed.php", "feedUrl=" + escape( url ), addFeedHandler, '' );
			}
			// END FEEDS

			// START TAGS
			function tagsHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;
				tagsDocument = result;
				showTags( document, tagsDocument );
			}
			function editTagHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				var idToFind = getNodeAttr( result.documentElement.childNodes[1], 'id' );
				if ( idToFind == null )
				{
					showDiv( document, 'error_tag', "Editar Categoría - El nodo no tiene id" );
					return;
				}
				var nodeFound = findNodeById( tagsDocument.documentElement.childNodes[1], idToFind );
				tagsDocument.documentElement.childNodes[1].replaceChild( result.documentElement.childNodes[1], nodeFound );
				showTags( document, tagsDocument );
			}
			function delTagHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				var idToFind = getNodeAttr( result.documentElement.childNodes[1], 'id' );
				if ( idToFind == null )
				{
					showDiv( document, 'error_tag', "Borrar Categoría - El nodo no tiene id" );
					return;
				}
				var nodeFound = findNodeById( tagsDocument.documentElement.childNodes[1], idToFind );
				tagsDocument.documentElement.childNodes[1].removeChild( nodeFound )
				showTags( document, tagsDocument );
			}
			function addTagHandler( result )
			{
				result = checkError( document, result );
				if ( result == null ) return;

				tagsDocument.documentElement.childNodes[1].appendChild( result.documentElement.childNodes[1] );
				showTags( document, tagsDocument );
			}
			function addTag( inputId )
			{
				var txtInput = document.getElementById( inputId );
				var name = txtInput.value;
				if ( name == '' )
				{
					alert( 'Debe ingresar el nombre de la categoría' );
					return;
				}
				txtInput.value = "";
				doAction ( "actionCode=" + escape( "T1" ) + "&params=" + escape( "tagName||#" + name ), addTagHandler, '' );
			}
			function editTag( tagId, oldTagName )
			{
				var name = prompt( 'Ingrese el nuevo nombre de la categoría', oldTagName );
				if ( name != oldTagName )
					doAction ( "actionCode=" + escape( "T3" ) + "&params=" + escape( "tagId||#" + tagId + "|||tagName||#" + name ), editTagHandler, '' );
			}
			// END TAGS

			// GENERAL
			function doActionWithName( pageName, params, handler, type )
			{
				hideDiv( document, 'error_tag', '' );

				if ( type == 'F' )
				{
					setCurrentFeed( params );
					showDiv( document, 'loading_feeds', null );
					hideDiv( document, 'menu_feeds', '' );
				}
				else if ( type == 'T' )
				{
					setCurrentTag( params );
					showDiv( document, 'loading_tags', null );
					hideDiv( document, 'menu_tags', '' );
				}
				else if ( type == 'A' )
				{
					setCurrentBody( params );
					showDiv( document, 'loading_body', null );
					hideDiv( document, 'chrome', '' );
				}
				else showDiv( document, 'processing_div', null );

				params = '?port=12000&'+params;
				//SimpleAJAXCall ( pageName + params, SimpleCallback, "GET", handler );
				MakeNewAJAXCall( pageName + params, SimpleCallback, "GET", null, handler, null );
			}
			function doAction( params, handler, type )
			{
				// "do_action.php"
				doActionWithName( "bin/thin_client.exe", params, handler, type );
			}
			function SimpleCallback( in_text, in_param )
			{
				in_param( in_text );
			}
			function reload()
			{
				hideDiv( document, 'processing_div', null );

				doAction ( getCurrentBody(), bodyHandler, 'A' );
				doAction ( getCurrentFeed(), feedsHandler, 'F' );
				doAction ( getCurrentTag(), tagsHandler  , 'T' );

				document.addEventListener( "keypress", document_keyPress, false);
			}
			function document_keyPress( e )
			{
				var el1 = document.getElementById( 'quickaddFeed' );
				var el2 = document.getElementById( 'quickaddTag' );
				if ( e.which == 13 )
				{
					if ( e.target == el1 )
					{
						addFeed( 'quickaddFeed' )
						return false;
					}

					if ( e.target == el2 )
					{
						addTag( 'quickaddTag' )
						return false;
					}

				}
			}


			function getCurrentBody()
			{
				return document.getElementById('currentBody').value;
			}
			function getCurrentFeed()
			{
				return document.getElementById('currentFeed').value;
			}
			function getCurrentTag()
			{
				return document.getElementById('currentTag').value;
			}
			function setCurrentBody( queryString )
			{
				document.getElementById('currentBody').value = queryString;
			}
			function setCurrentFeed( queryString )
			{
				document.getElementById('currentFeed').value = queryString;
			}
			function setCurrentTag( queryString )
			{
				document.getElementById('currentTag').value  = queryString;
			}

			var cX = 0; var cY = 0;
			function updateCursorPosition( e )
			{
				cX = e.pageX;
				cY = e.pageY;
			}
			function updateCursorPositionDocAll( e )
			{
				cX = event.clientX;
				cY = event.clientY;
			}
			function assignPosition( d )
			{
				d.style.left = (cX+10) + "px";
				d.style.top = (cY+10) + "px";
			}

			if ( document.all )
				document.onmousemove = updateCursorPositionDocAll;
			else
				document.onmousemove = updateCursorPosition;

		</script>

	</head>

	<body onload="reload()">
		<input id="currentBody"  name="currentBody"  type="hidden" value="actionCode=A6" />
		<input id="currentFeed" name="currentFeeds" type="hidden" value="actionCode=F3" />
		<input id="currentTag"  name="currentTags"  type="hidden" value="actionCode=T4" />

		<div id="pag">
			<div id="nav">
				<div id="menu_main">
					<table cellspacing="0" cellpadding="0" border="0" id="selectors-box" class="round-box">
						<tr>
							<td class="s tl"/>
							<td class="s"/>
							<td class="s tr"/>
						</tr>
						<tr>
							<td class="s"/>
							<td class="c">
								<div class="sub-tree-header">Inicio</div>
								<table>
									<tr>
										<td class="menuIcon">
											<a class="link" onclick="doAction ( 'actionCode=A6', bodyHandler, 'A' );">
											<img style="border:0" src="images/status_unread.png" title="Icono de status no leido" alt="Icono de status no leido"/>
											</a>
										</td>
										<td class="menuName">
											<a class="link" onclick="doAction ( 'actionCode=A6', bodyHandler, 'A' );">No Leidos</a>
										</td>
									</tr>
									<tr>
										<td class="menuIcon">
											<a class="link" onclick="doAction ( 'actionCode=A7', bodyHandler, 'A' );">
											<img style="border:0" src="images/status_unclasi.png" title="Icono de status no clasificado" alt="Icono de status no clasificado"/>
											</a>
										</td>
										<td class="menuName">
											<a class="link" onclick="doAction ( 'actionCode=A7', bodyHandler, 'A' );">No Clasificados</a>
										</td>
									</tr>

									<tr>
										<td class="menuIcon">
											<a class="link" onclick="doAction ( 'actionCode=A10', bodyHandler, 'A' )">
												<img style="border:0" src="images/status_fav.png" title="Icono de status favorito" alt="Icono de status favorito"/>
											</a>
										</td>
										<td class="menuName">
											<a class="link" onclick="doAction ( 'actionCode=A10', bodyHandler, 'A' )">Favoritos</a>
										</td>
									</tr>

								</table>
							</td>
							<td class="s"/>
						</tr>
						<tr>
							<td class="s bl"/>
							<td class="s"/>
							<td class="s br"/>
						</tr>
					</table>
				</div>

				<div id="loading_tags">
					<table cellspacing="0" cellpadding="0" border="0" id="selectors-box" class="round-box">
						<tr>
							<td class="s tl"/>
							<td class="s"/>
							<td class="s tr"/>
						</tr>
						<tr>
							<td class="s"/>
							<td class="c">
								<div class="sub-tree-header-loading">Cargando categorías...</div>
							</td>
							<td class="s"/>
						</tr>
						<tr>
							<td class="s bl"/>
							<td class="s"/>
							<td class="s br"/>
						</tr>
					</table>
				</div>
				<div id="menu_tags"></div>
				<div id="menu_add_tag">
					<table cellspacing="0" cellpadding="0" border="0" id="selectors-box" class="round-box">
						<tr>
							<td class="s tl"/>
							<td class="s"/>
							<td class="s tr"/>
						</tr>
						<tr>
							<td class="s"/>
							<td class="c" align="center">
								<div class="sub-tree-header">Crear Categoría</div>
								<span id="quick-add-instructions">Ingrese el nombre</span>
								<table>
									<tr>
										<td class="menuName">
											<input type="text" id="quickaddTag" name="quickaddTag" class="quickAddTag" value=""/>
										</td>
										<td class="menuIcon">
											<a class="link" onclick="addTag( 'quickaddTag' )">
												<img style="border:0" src="images/action_tag_add.png" title="Agregar categoría" alt="Agregar categoría"/>
											</a>
										</td>
									</tr>
								</table>


							</td>
							<td class="s"/>
						</tr>
						<tr>
							<td class="s bl"/>
							<td class="s"/>
							<td class="s br"/>
						</tr>
					</table>
				</div>
				<div id="loading_feeds">
					<table cellspacing="0" cellpadding="0" border="0" id="selectors-box" class="round-box">
						<tr>
							<td class="s tl"/>
							<td class="s"/>
							<td class="s tr"/>
						</tr>
						<tr>
							<td class="s"/>
							<td class="c">
								<div class="sub-tree-header-loading">Cargando feeds...</div>
							</td>
							<td class="s"/>
						</tr>
						<tr>
							<td class="s bl"/>
							<td class="s"/>
							<td class="s br"/>
						</tr>
					</table>
				</div>
				<div id="menu_feeds"></div>

				<div id="menu_add_feed">
					<table cellspacing="0" cellpadding="0" border="0" id="selectors-box" class="round-box">
						<tr>
							<td class="s tl"/>
							<td class="s"/>
							<td class="s tr"/>
						</tr>
						<tr>
							<td class="s"/>
							<td class="c" align="center">
								<div class="sub-tree-header">Suscribirse</div>
								<span id="quick-add-instructions">Ingrese la dirección</span>
								<table>
									<tr>
										<td class="menuName">
											<input type="text" id="quickaddFeed" name="quickaddFeed" class="quickaddFeed" value=""/>
										</td>
										<td class="menuIcon">
											<a class="link" onclick="addFeed( 'quickaddFeed' )">
												<img style="border:0" src="images/action_feed_add.png" alt="Agregar feed" title="Agregar feed"/>
											</a>
										</td>
									</tr>
								</table>


							</td>
							<td class="s"/>
						</tr>
						<tr>
							<td class="s bl"/>
							<td class="s"/>
							<td class="s br"/>
						</tr>
					</table>
				</div>

				<div id="processing_div" class="processing" style="display: none">Procesando...</div>
			</div>

			<div id="error_tag" class="error" style="display: none">Aca va a ir el mensaje de error cuando este ocurra</div>

			<div id="loading_body">Buscando articulos, aguarde un momento...</div>
			<div id="chrome"></div>

			<div id="tagsToLink" onmouseout='startTimerToSelectCat()' onmouseover='keepCatsVisible()'><div>
		</div>
	</body>
</html>
